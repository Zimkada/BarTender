# CUMP Implementation - Complete Testing Guide

**Date**: 2025-12-18
**Related Migrations**: 20251218000000, 20251218000001, 20251218000002
**Status**: Ready for QA

---

## 1. PRE-DEPLOYMENT CHECKS

### 1.1 Database Migrations Order

**CRITICAL**: Migrations MUST run in this order:

```
1. 20251218000000_add_current_average_cost_to_products.sql
   ├─ Adds bar_products.current_average_cost column
   ├─ Initializes with CUMP from supplies < 90 days
   └─ Creates performance index

2. 20251218000001_optimize_product_sales_stats_with_cump.sql
   ├─ Drops and recreates product_sales_stats view
   ├─ Uses new current_average_cost column
   └─ Eliminates supplies JOIN

3. 20251218000002_add_trigger_update_current_average_cost.sql
   ├─ Creates automatic update function
   ├─ Triggers on supplies INSERT/UPDATE/DELETE
   └─ Keeps current_average_cost in sync
```

### 1.2 Code Changes

✅ **Modified Files:**
- `src/types/index.ts` - Added `currentAverageCost?: number` to Product interface
- `src/features/Sales/SalesHistory/views/AnalyticsView.tsx` - Updated profit calculation
- `MIGRATION_LOG.md` - Documented all changes

⏳ **Pending (auto-generated by Supabase CLI):**
- `src/lib/database.types.ts` - Run `supabase gen types typescript` to regenerate

---

## 2. LOCAL TESTING (Development)

### 2.1 Setup Test Data

```sql
-- 1. Create test bar (if needed)
INSERT INTO bars (name, address, phone, city)
VALUES ('Test Bar CUMP', '123 Test St', '+1234567890', 'Cotonou')
RETURNING id;
-- Save the ID as {BAR_ID}

-- 2. Create test category
INSERT INTO bar_categories (bar_id, name, color)
VALUES ('{BAR_ID}', 'Beverages', '#FF6B35')
RETURNING id;
-- Save as {CATEGORY_ID}

-- 3. Create test product
INSERT INTO bar_products (bar_id, local_name, price, stock, category_id, alert_threshold, is_custom_product)
VALUES ('{BAR_ID}', 'Test Beer 500ml', 10000, 0, '{CATEGORY_ID}', 10, TRUE)
RETURNING id;
-- Save as {PRODUCT_ID}
```

### 2.2 Test CUMP Initialization

```sql
-- Before supplies: current_average_cost should be 0
SELECT id, display_name, current_average_cost, stock
FROM bar_products
WHERE id = '{PRODUCT_ID}';
-- Expected: current_average_cost = 0

-- Add first supply
INSERT INTO supplies (bar_id, product_id, quantity, unit_cost, total_cost, supplier_name, supplied_by, supplied_at)
VALUES (
  '{BAR_ID}',
  '{PRODUCT_ID}',
  100,
  4000,
  400000,
  'Supplier A',
  auth.uid(),
  NOW()
);

-- Check: current_average_cost should update automatically
SELECT id, display_name, current_average_cost, stock
FROM bar_products
WHERE id = '{PRODUCT_ID}';
-- Expected: current_average_cost = 4000 (100 @ 4000)
```

### 2.3 Test CUMP Weighted Average

```sql
-- Add second supply at different price
INSERT INTO supplies (bar_id, product_id, quantity, unit_cost, total_cost, supplier_name, supplied_by, supplied_at)
VALUES (
  '{BAR_ID}',
  '{PRODUCT_ID}',
  50,
  4400,
  220000,
  'Supplier B',
  auth.uid(),
  NOW()
);

-- Check CUMP calculation
SELECT
  id,
  display_name,
  current_average_cost,
  stock
FROM bar_products
WHERE id = '{PRODUCT_ID}';

-- Expected calculation:
-- CUMP = (100 * 4000 + 50 * 4400) / (100 + 50)
--      = (400000 + 220000) / 150
--      = 620000 / 150
--      = 4133.33 FCFA/unit

-- Verify:
-- current_average_cost = 4133.33 (approximately)
```

### 2.4 Test Trigger on DELETE

```sql
-- Delete first supply
DELETE FROM supplies
WHERE product_id = '{PRODUCT_ID}'
  AND unit_cost = 4000
  AND quantity = 100;

-- Check: CUMP should recalculate
SELECT current_average_cost
FROM bar_products
WHERE id = '{PRODUCT_ID}';

-- Expected: current_average_cost = 4400 (only second supply remains)
```

### 2.5 Test Profit Calculation in Top Products

```sql
-- 1. Add stock to product
UPDATE bar_products
SET stock = 150
WHERE id = '{PRODUCT_ID}';

-- 2. Create a sale with this product
-- Via UI: Go to Sales > Create sale > Add product at 10000 FCFA > Sell 10 units

-- 3. Check Analytics > Historique > Top Produits > Mode "Bénéfice"
-- Expected profit calculation:
-- Revenue: 10 * 10000 = 100000 FCFA
-- Cost: 10 * 4133.33 = 41333.33 FCFA
-- Profit: 100000 - 41333.33 = 58666.67 FCFA

-- SQL verification:
SELECT
  product_id,
  SUM((si->>'quantity')::integer) as units_sold,
  SUM(((si->>'quantity')::integer * (si->>'unit_price')::numeric)) as revenue,
  (SELECT current_average_cost FROM bar_products WHERE id = '{PRODUCT_ID}') as cump,
  SUM(((si->>'quantity')::integer * (SELECT current_average_cost FROM bar_products WHERE id = '{PRODUCT_ID}'))) as cost,
  SUM(((si->>'quantity')::integer * (si->>'unit_price')::numeric)) -
  SUM(((si->>'quantity')::integer * (SELECT current_average_cost FROM bar_products WHERE id = '{PRODUCT_ID}'))) as profit
FROM sales s,
LATERAL jsonb_array_elements(s.items) as si
WHERE s.bar_id = '{BAR_ID}'
  AND (si->>'product_id')::uuid = '{PRODUCT_ID}'
  AND s.status = 'validated'
GROUP BY product_id;
```

### 2.6 Test 90-day Window Exclusion

```sql
-- Create supply older than 90 days
INSERT INTO supplies (bar_id, product_id, quantity, unit_cost, total_cost, supplier_name, supplied_by, supplied_at)
VALUES (
  '{BAR_ID}',
  '{PRODUCT_ID}',
  1000,
  2000,  -- Very cheap, old stock
  2000000,
  'Supplier Old',
  auth.uid(),
  NOW() - INTERVAL '120 days'
);

-- Check CUMP - old supply should be IGNORED
SELECT current_average_cost
FROM bar_products
WHERE id = '{PRODUCT_ID}';

-- Expected: current_average_cost = 4133.33 (NOT affected by old 2000 unit_cost)
-- This ensures old stock doesn't skew current CUMP
```

---

## 3. PRODUCTION TESTING (Staging)

### 3.1 Real Data Verification

```sql
-- Check all products have been initialized
SELECT
  COUNT(*) as total_products,
  COUNT(CASE WHEN current_average_cost > 0 THEN 1 END) as with_cost,
  COUNT(CASE WHEN current_average_cost = 0 THEN 1 END) as without_cost,
  AVG(current_average_cost) as avg_cost,
  MAX(current_average_cost) as max_cost
FROM bar_products
WHERE is_active = true;
```

### 3.2 View Refresh Check

```sql
-- Verify view refresh completes
SELECT
  COUNT(*) as total_in_view,
  COUNT(DISTINCT bar_id) as bars,
  COUNT(CASE WHEN avg_purchase_cost > 0 THEN 1 END) as with_cost
FROM product_sales_stats_mat;

-- Should complete without errors (20-30% faster than before)
```

### 3.3 Analytics Performance Test

```sql
-- Measure query performance before/after
-- In AnalyticsView - check console for timing:

-- Before: Recalculating CUMP on every load
-- After: Direct field access from currentAverageCost

-- Expected improvement: 30-40% faster top products calculation
```

---

## 4. REGRESSION TESTING

### 4.1 Ensure No Breaking Changes

```typescript
// In src/features/Sales/SalesHistory/views/AnalyticsView.tsx
// Verify top products still load correctly with:
// - topProductsData.byUnits loads ✅
// - topProductsData.byRevenue loads ✅
// - topProductsData.byProfit loads ✅ (NOW WITH REAL PROFIT)

// Verify sorting works:
// - Profit ranking should differ from revenue ranking ✅
// - High volume doesn't = high profit ✅
```

### 4.2 Returns Handling

```sql
-- Create a return and verify cost is deducted correctly
-- Expected behavior:
-- - Return deducts revenue
-- - Return also deducts cost (product cost × quantity)
-- - Profit = (revenue - cost) still correct
```

---

## 5. DEPLOYMENT CHECKLIST

- [ ] Backup database
- [ ] Run migration 20251218000000 (add column)
- [ ] Run migration 20251218000001 (optimize view)
- [ ] Run migration 20251218000002 (add triggers)
- [ ] Verify all 3 migrations succeeded
- [ ] Update code: src/types/index.ts ✅
- [ ] Update code: src/features/Sales/SalesHistory/views/AnalyticsView.tsx ✅
- [ ] Regenerate types: `supabase gen types typescript`
- [ ] Run local test suite
- [ ] Deploy to staging
- [ ] Run staging tests (Section 3)
- [ ] Deploy to production
- [ ] Monitor logs for trigger errors
- [ ] Verify Top Products "Bénéfice" shows correct values

---

## 6. ROLLBACK PLAN (If Needed)

```sql
-- 1. Drop triggers
DROP TRIGGER IF EXISTS trg_supplies_after_insert ON supplies;
DROP TRIGGER IF EXISTS trg_supplies_after_update ON supplies;
DROP TRIGGER IF EXISTS trg_supplies_after_delete ON supplies;
DROP FUNCTION IF EXISTS update_product_current_average_cost();

-- 2. Restore old view (from migration 057)
-- (Manual step - restore from version control)

-- 3. Remove column (requires downtime)
ALTER TABLE bar_products DROP COLUMN current_average_cost;

-- 4. Revert code changes (git checkout)
```

---

## 7. SUCCESS CRITERIA

✅ **System is working correctly when:**

1. **Column Exists**
   - `bar_products.current_average_cost` exists
   - All products have a value (0 or calculated)

2. **Triggers Work**
   - New supply added → `current_average_cost` updates automatically
   - Supply deleted → `current_average_cost` recalculates
   - No SQL errors in logs

3. **Analytics Correct**
   - Top Products → "Bénéfice" tab shows profit (not revenue)
   - Profit = (price - CUMP) × quantity_sold
   - Ranking changes compared to revenue

4. **Performance**
   - product_sales_stats_mat refresh completes < 30 seconds
   - Analytics page loads without delays
   - No N+1 queries in console

5. **Data Integrity**
   - Returns deduct cost correctly
   - 90-day window excludes old supplies
   - Margin calculation in Inventory matches CUMP

---

## 8. KNOWN LIMITATIONS

1. **90-day window**: Stock older than 90 days not included in CUMP
   - Workaround: Adjust interval in migration if needed

2. **Trigger overhead**: Recalculates on every supply change
   - Acceptable for typical bar (few supplies/day)
   - If huge volume (>1000 supplies/day): consider batch update

3. **Returns on old stock**: Cost deducted at current CUMP, not original
   - Acceptable: Matches accounting standards

---

**Questions?** See MIGRATION_LOG.md for technical details.
